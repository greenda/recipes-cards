<!-- https://color.romanuke.com/czvetovaya-palitra-4528/
<!-- #5C7728
#F8AE29
#F7F7F9
#FFC9B3
#B76C49 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html {
      width: 100vw;
      height: 100vh;
    }

    body {
      font-family: monospace;
      color: #1B1D19;
    }

    .page {
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr 800px 1fr;
    }

    .page__title {
      display: grid;
      justify-content: center;
    }

    .table__head {
      display: grid;
      grid-template-columns: 226px 226px 226px 36px 36px;
      height: 42px;
      background: #DBB6A4;
    }

    .table__head div {
      /* border: 4px solid white; */
      display: grid;
      justify-items: center;
      align-items: center;
      padding: 8px 0px;
      border-bottom: 0;
    }

    .table__head div:not(:last-child) {
      border-right: 0;
    }

    /* TODO миксин */
    .table__row {
      display: grid;
      grid-template-columns: 226px 226px 226px 32px 32px;
      border: 1px solid #E5E5E5;
      border-top: 0;
      border-bottom: 0;
    }

    .table__row:last-child {
      border: 1px solid #E5E5E5;
    }

    .table__cell {
      padding: 8px;
      border-bottom: 0;
    }

    .table__cell:not(:last-child) {
      border-right: 0px;
    }

    .table {
      width: 752px;
      font-size: 16px;
      color: #1B1D19;
      margin: 24px;
    }

    .table button {
      padding: 0px;
    }

    .table input {
      border: none;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #d9d9d9;
      font-size: 16px;
    }

    .add-button {
      background-image: url(edit-icon.svg);
      background-size: 100%;
      width: 32px;
      height: 32px;
      /* background: mediumaquamarine; */
      border: none;
      background-color: transparent;
    }

    .delete-button {
      background-image: url(cancell-icon.svg);
      background-size: 100%;
      width: 32px;
      height: 32px;
      /* background: mediumaquamarine; */
      border: none;
      background-color: transparent;
    }

    .table input:focus {
      border: 1px solid #d9d9d9;
      outline-color: #d9d9d9;
    }

    .table input:focus-visible {
      border: 1px solid #d9d9d9;
      outline-color: #d9d9d9;
    }

    .table input:active {
      border: 1px solid red;
    }

    .table__cell_type_ingredients div:not(:last-child) {
      margin-bottom: 4px;
    }

    .table__cell_type_units div:not(:last-child) {
      margin-bottom: 4px;
    }

    .text-input input {
      width: 192px;
    }

    .table__active-button {
      padding: 0;
      display: grid;
      align-items: center;
    }

    .create-card-button {
      background-color: #F8AE29;
      width: 192px;
      height: 42px;
      border-radius: 16px;
      border: none;
      font-family: monospace;
      color: #1B1D19;
      font-size: 14px;
    }

    .create-card-button:hover {
      background-color: #EEA729;
    }

    .copy-card-button {
      background-color: #B76C49;
      width: 192px;
      height: 42px;
      border-radius: 16px;
      border: none;
      font-family: monospace;
      color: #1B1D19;
      font-size: 14px;
    }

    .copy-card-button:hover {
      background-color: #a86342;
    }

    .active-buttons {
      margin: 24px;
      margin-top: 0px;
      display: flex;
      flex-direction: row;
      justify-content: flex-end;
      gap: 10px;
      font-family: monospace;
      font-size: 14px;
    }

  .title {
    font-size: 24px;
    font-family: 'FreeMono';
    text-align: center;
    stroke: #000000;
  }

  .content {
    font-size: 16px;
    font-family: 'FreeMono';
    fill: #000000;
  }

  .preparing {
    font-style: italic;
    font-size: 24px;
    font-family: 'FreeMono';
    text-align: center;
    fill: #000000;
  }

  .preparing__content {
    font-family: 'FreeMono';
    font-size: 16px;
    fill: #000000;
  }

  .recipe__container {
    fill: none;
    stroke: black;
    stroke-width: 1;
  }

  .bold {
    font-weight: bold;
  }
  </style>
  <script type="module" src="./src/app/components/select-with-search/index.js"></script>
  <script>
    // console.log('%c%s', 'background: cadetblue; padding: 8px;', 'loadTemplates');
    // const loadTemplates = async () => {
    //   //get the imported document in templates:
    //   var templates = document.createElement( 'template' )
    //   templates.innerHTML = await ( await fetch( 'templates.html' ) ).text();
    // };

    // const loadTemplates = () => {
    //
    // }


  </script>
  <!-- <script src="./src/index.js"></script> -->
  <title>Document</title>
</head>

<body>
  <div w3-include-html="templates.html"></div>
  <script>
    // const loadTemplates = async () => {
    //   var templates = document.createElement( 'template' )
    //   // const templatesFile = await fetch( 'templates.html' );
    //   templates.innerHTML = await ( await fetch( 'templates.html' ) ).text();
    //   document.querySelector('body').appendChild(templates);
    // };

    // loadTemplates();
  </script>
  <div class="page">
    <template id="select-with-search">
      <style>
        .select__add-button {
          background-repeat: no-repeat;
          background-position-y: center;
          background-image: url('add-icon.svg');
          width: 24px;
          height: 24px;
          border: none;
          background-color: transparent;
        }

        .select__add-button:hover {
          background-image: url('add-icon_hover.svg');
        }

        .select__container {
          max-height: calc(55px * 6);
          overflow-y: scroll;
          position: absolute;
          background: white;
          display: block;
          border: 1px solid #E5E5E5;
          width: 180px;
          box-shadow: 0px 2px 8px 0px rgb(34 60 80 / 20%);
          z-index: 10;
        }

        .select__option {
          padding: 8px;
          border-bottom: 1px solid #E5E5E5;
        }

        .select__option:hover {
          background-color: #F8AE29;
        }

        .select__field {
          display: grid;
          grid-template-columns: 182px 24px;
          gap: 4px;
          align-items: center;
          position: relative;
        }

        .select:focus-visible {
          outline: 1px solid rgb(110, 0, 0);
          border: 1px solid rgb(52, 4, 4);
        }

        #s1:focus-visible {
          outline: 1px solid #1a1d75;
        }

        button:focus-visible {
          outline: 1px solid #B0B0B0;
        }

        .select input {
          border: none;
          padding: 8px;
          border-radius: 4px;
          border: 1px solid #d9d9d9;
          font-size: 16px;
        }

        .select input:focus-visible {
          outline: 1px solid #B0B0B0;
        }

        .select__hide-button {
          position: absolute;
          background-image: url(./hide-select-button.svg);
          background-color: transparent;
          border: none;
          height: 36px;
          width: 30px;
          left: 152px;
          background-repeat: no-repeat;
          background-position-y: 16px;
          background-position-x: 8px;
          padding: 0;
        }

        .select__container.hide {
          display: none;
        }
      </style>

      <!-- TODO сделать это через b() -->
      <div class="select">
        <div class="select__field">
          <input type="text" class="select__input" />
          <button class="select__add-button"></button>
          <button class="select__hide-button"></button>
        </div>
        <div class="select__container  hide">
        </div>
      </div>
    </template>
    <div></div>
    <div>
      <div class="page__title">
        <h1>Добавление рецепта</h1>
      </div>
      <div class="table">
        <div class="table__head">
          <div>
            Ингредиент
          </div>
          <div>
            Количество
          </div>
          <div>
            Единицы измерения
          </div>
          <div class="table__head_type_button"></div>
          <div class="table__head_type_button"></div>
        </div>
        <div class="table__content"></div>
      </div>
      <div class="active-buttons">
        <button class="create-card-button" onclick="createCard()">Нарисовать карточку</button>
        <button class="create-card-button" onclick="createCard()">Скопировать карточку</button>
        <button class="copy-card-button" onclick="copyCard()">Скопировать JSON</button>
      </div>
      <div class="cards">
        <div class="cards__container">
          <svg width="208mm" height="148mm" fill="white"></svg>
        </div>
      </div>
    </div>
    <div></div>
  </div>
  <script>
    onAddOption = event => {
      const newId = Math.max(...INGREDIENTS.map(({ id }) => id)) + 1;

      updateIngredients([...INGREDIENTS, { id: newId, label: event.currentTarget.newOption }]);
    }

    // TODO вынести таблицу в объект

    addRow = () => {
      const ingredientSelectId = `s${window.maxIndex + 1}`;
      const unitSelectId = `s${window.maxIndex + 2}`;

      const rowIndex = window.rowIndex;

      addTableRow({ ingredientSelectId, unitSelectId, rowIndex: window.rowIndex });
      window.maxIndex = window.maxIndex + 3;

      window.table = [
        ...window.table,
        {
          rowIndex,
          ingredients: window[ingredientSelectId],
          units: window[unitSelectId],
        },
      ];

      updateIngredients(INGREDIENTS);
      updateUnits(UNITS);
      updateListeners();
    }

    removeRow = event => {
      const rowIndex = event.target.parentNode.parentNode.getAttribute('rowindex');

      window.table = window.table.filter(({ rowIndex: index }) => index !== rowIndex);

      console.log('%c%s', 'background: cadetblue; padding: 8px;', 'removeRow');

      document.querySelector(`.table__row[rowindex="${rowIndex}"]`).remove();

      // console.log('%c%s', 'background: cadetblue; padding: 8px;', JSON.stringify(window.table));
    }

    // TODO вынести функции работы с карточкой в объект
    const mm = value => `${value}mm`;
    const NAMESPACE = 'http://www.w3.org/2000/svg';
    const CARD_WIDTH = 104;
    const CARD_HEIGHT = 148;
    const BASE_OFFSET = 16;
    const PRODUCTS_OFFSET = 50;
    const INGREDIENTS_MAX_CHAR_COUNT = 20;
    const DIRECTIONS_MAX_CHAR_COUNT = 34;
    const TYPE = {
      SVG: 'svg',
      GROUP: 'g',
      RECTANGLE: 'rect',
      TEXT: 'text',
      TSPAN: 'tspan'
    };

    const createSvgElement = (type, attrs = {}, textContent = '') => {
    const node = document.createElementNS(NAMESPACE, type);

    Object.entries(attrs).forEach(([key, value]) => {
      node.setAttribute(key, value);
    });

    if ([TYPE.TEXT, TYPE.TSPAN].includes(type)) {
      node.textContent = textContent;
    }

    return node;
  };

  const trimRow = (limit, text) => text.split(' ')
    .reduce((acc, word, index) => {
      const lastElement = acc.length - 1;
      if (index === 0) return [word];

      const prevElement = acc[lastElement];

      return prevElement.length < 3
        ? [...acc.slice(0, -1), `${prevElement} ${word}`]
        : [...acc, word];
    }, [])
    .reduce((acc, word) => {
      if (!acc.length) return [word]; const lastIndex = acc.length - 1; const lastElement = acc[lastIndex]; const rowWithNewWord = `${lastElement} ${word}`; return rowWithNewWord.length < limit ? [...acc.slice(0, -1), rowWithNewWord] : [...acc, word];
    }, []);

    const createCardSvg = (recipe, x0, y0) => {
      const startX = +x0;
      const startY = +y0;

      let svg = document.querySelector('svg');

      const container = document.querySelector('.cards__container');

      if (!svg) {
        svg = createSvgElement(TYPE.SVG, { width: mm(210), height: mm(297) });
      }

      const recipeGroup = createSvgElement(TYPE.GROUP);

      const recipeContainer = createSvgElement(
        TYPE.RECTANGLE, {
        x: mm(startX),
        y: mm(startY),
        width: mm(CARD_WIDTH),
        height: mm(CARD_HEIGHT),
        class: 'recipe__container'
      });

      const {
        id,
        title,
        ingredients,
        directions
      } = recipe;

      const recipeTitle = createSvgElement(TYPE.TEXT, {
        'text-anchor': 'middle',
        x: mm(startX + CARD_WIDTH / 2),
        y: mm(startY + BASE_OFFSET),
        class: 'title',
        style: `${title.length > 20 ? 'font-size: 16px;' : ''}`
      },
        `${id}. ${title}`
      );

      const ingredientsAmountOfGroup = createSvgElement(TYPE.GROUP, { class: 'content' });

      const ingredientMainText = createSvgElement(TYPE.TEXT, {
        x: mm(startX + BASE_OFFSET),
        y: mm(startY + BASE_OFFSET * 2)
      });

      const ingredientProductsText = createSvgElement(TYPE.TEXT, {
        x: mm(startX + PRODUCTS_OFFSET),
        y: mm(startY + BASE_OFFSET * 2)
      });

      ingredients.reduce((acc, { ingredientId, ...rest }) => {
        const a = window.INGREDIENTS.find(({ id }) => id === ingredientId);

        const ingredientElementsRows = trimRow(INGREDIENTS_MAX_CHAR_COUNT, window.INGREDIENTS.find(({ id }) => id === ingredientId).label);

        return [...acc, { ingredientId, ingredientElementsRows, ...rest }];
      }, [])
        .reduce((acc, { amountOf, unitId, index: unitIndex, isAnalogue, ingredientId, ingredientElementsRows }, index) => {
          const isFirstRow = index === 0; const lastRowCount = isFirstRow ? 1 : acc[acc.length - 1].rowCount;

          const unit = window.UNITS.find(({ id }) => id === unitId).label;

          const amountOfUnitElement = createSvgElement(TYPE.TSPAN, {
            x: mm(startX + BASE_OFFSET),
            dy: isFirstRow ? '0' :
              isAnalogue ? '0.8em' : `${(lastRowCount + 1) * 0.8}em`
          },
            `▪ ${amountOf || ''} ${Array.isArray(unit) ? unit[unitIndex] : unit}`);

          ingredientMainText.appendChild(amountOfUnitElement); ingredientElementsRows.forEach((word, wordIndex) => {
            const productRow = createSvgElement(TYPE.TSPAN, {
              x: mm(startX + PRODUCTS_OFFSET),
              dy: isFirstRow && wordIndex === 0 ? '0' : wordIndex === 0 && !isAnalogue ? '1.6em' : '0.8em'
            },
              isAnalogue ? `или ${word.toLowerCase()}` : word); ingredientProductsText.appendChild(productRow);
          });

          return [...acc, { rowCount: ingredientElementsRows.length }];
        }, []);

      ingredientsAmountOfGroup.appendChild(ingredientMainText);
      ingredientsAmountOfGroup.appendChild(ingredientProductsText);

      recipeGroup.appendChild(recipeContainer);
      recipeGroup.appendChild(recipeTitle);
      recipeGroup.appendChild(ingredientsAmountOfGroup);
      svg.appendChild(recipeGroup);
      container.appendChild(svg);

      // ---------------------------- //

      const directionsGroup = createSvgElement(TYPE.GROUP, {
        class: 'content'
      });

      const directionsTitle = createSvgElement(TYPE.TEXT, {
        // TODO 52 в константы
        x: mm(startX + CARD_WIDTH + 52),
        y: mm(startY + BASE_OFFSET),
        'text-anchor': 'middle',
        class: 'preparing'
      }, 'Приготовление');

      const directionsMainText = createSvgElement(TYPE.TEXT, {
        x: mm(startX + CARD_WIDTH + BASE_OFFSET / 2),
        y: mm(startY + BASE_OFFSET * 2), class: 'preparing__content'
      });

      const PIXEL_IN_MM = 0.26; directions.forEach((direction, index) => {
        trimRow(DIRECTIONS_MAX_CHAR_COUNT, direction).forEach((row, rowIndex) => {
          if (rowIndex === 0) {
            directionsMainText.appendChild(createSvgElement(TYPE.TSPAN, {
              x: mm(startX + CARD_WIDTH + BASE_OFFSET / 2),
              dy: index === 0 && rowIndex === 0 ? '0' : rowIndex === 0 ? '1.5em' : '0.8em', class: 'bold'
            }, `${index + 1}.`));
          }

          directionsMainText.appendChild(createSvgElement(TYPE.TSPAN, {
            x: rowIndex === 0 ? mm(startX + CARD_WIDTH + BASE_OFFSET / 2 + 16 * (`${index}`.length + 1) * PIXEL_IN_MM)
              : mm(startX + CARD_WIDTH + BASE_OFFSET), dy: rowIndex === 0 ? '0' : rowIndex === 0 ? '1.5em' : '0.8em'
          }, row));
        });
      });

      const directionsContainer = createSvgElement(TYPE.RECTANGLE, {
        x: mm(startX + CARD_WIDTH),
        y: mm(startY),
        width: mm(CARD_WIDTH),
        height: mm(CARD_HEIGHT),

        // TODO вынести в класс
        style: 'fill: none; stroke: black; stroke-width: 1'
      });

      recipeGroup.appendChild(directionsGroup);
      recipeGroup.appendChild(directionsTitle);
      recipeGroup.appendChild(directionsMainText);
      recipeGroup.appendChild(directionsContainer);

      const topHoleRect = createSvgElement(TYPE.RECTANGLE, {
        x: mm(0 + startX),
        y: mm(32 + startY),
        width: mm(10),
        height: 2,
        // TODO в стиль
        style: 'fill: #dfdfdf; stroke: none;'
      });
      const bottomHoleRect = createSvgElement(TYPE.RECTANGLE, {
        x: mm(0 + startX),
        y: mm(112 + startY),
        width: mm(10),
        height: 2,
        // TODO в стиль
        style: 'fill:#dfdfdf; stroke: none;'
      });

      recipeGroup.appendChild(topHoleRect);
      recipeGroup.appendChild(bottomHoleRect);
    };

    createCard = () => {
      createCardSvg({
        id: 1,
        title: 'Здесь будет название рецепта',
        ingredients: copyCard(),
        directions: ['Здесь будет описание']
      }, 0, 0);
      // createCard(0, 148);
    }

    copyCard = () => {
      const acc = window.table.reduce((acc, { rowIndex, ingredients, units }, index) => {
        console.log('%c%s', 'background: cadetblue; padding: 8px;', rowIndex);
        const ingredient = ingredients.input.value;
        const ingredientId = window.INGREDIENTS.find(({ label }) => label === ingredient)?.id;
        const amountOf = document.querySelector(`.table__row[rowindex="${rowIndex}"] .amount-of__input`)?.value;
        const unit = units.input.value;
        const unitId = window.UNITS.find(({ label }) => label === unit)?.id;

        return [
          ...acc,
          {
            ingredientId,
            amountOf,
            unitId,
          },
        ]
      }, []);

      return acc;
    }

    const addTableRow = ({ ingredientSelectId, unitSelectId, rowIndex }) => {
      const tableContentElement = document.querySelector('.table__content');
      const tabIndex = window.tabIndex;

      const rowElement = document.createElement('div');
      rowElement.className = 'table__row';

      // TODO сделать функцию для создания элемента с параметрами
      // В идеале для вложенных
      const ingredientsCell = document.createElement('div');
      ingredientsCell.className = 'table__cell';
      const ingredientsSelect = document.createElement('select-with-search');
      ingredientsSelect.id = ingredientSelectId;
      ingredientsCell.appendChild(ingredientsSelect);

      const countInputCell = document.createElement('div');
      countInputCell.className = 'table__cell';
      const countInputContаiner = document.createElement('div');
      countInputContаiner.className = 'text-input';
      const countInput = document.createElement('input');
      countInput.type = 'text';
      countInput.className = 'amount-of__input';
      countInput.tabIndex = tabIndex + 5;
      countInputContаiner.appendChild(countInput);
      countInputCell.appendChild(countInputContаiner);

      const unitsCell = document.createElement('div');
      unitsCell.className = 'table__cell';
      const unitsSelect = document.createElement('select-with-search');
      unitsSelect.id = unitSelectId;
      unitsCell.appendChild(unitsSelect);

      const tableAddButtonContainer = document.createElement('div');
      tableAddButtonContainer.className = 'table__cell table__active-button';
      const tableAddButton = document.createElement('button');
      tableAddButton.className = 'add-button';
      tableAddButton.tabIndex = tabIndex + 10;
      tableAddButton.onclick = this.addRow;
      tableAddButtonContainer.appendChild(tableAddButton);

      const tableDeleteButtonContainer = document.createElement('div');
      tableDeleteButtonContainer.className = 'table__cell table__active-button';
      const tableDeleteButton = document.createElement('button');
      tableDeleteButton.className = 'delete-button';
      tableDeleteButton.onclick = this.removeRow;
      tableDeleteButton.tabIndex = tabIndex + 11;
      tableDeleteButtonContainer.appendChild(tableDeleteButton);

      rowElement.appendChild(ingredientsCell);
      rowElement.appendChild(countInputCell);
      rowElement.appendChild(unitsCell);
      rowElement.appendChild(tableAddButtonContainer);
      rowElement.appendChild(tableDeleteButtonContainer);

      tableContentElement.appendChild(rowElement);

      window.tabIndex = window.tabIndex + 10;

      rowElement.setAttribute('rowIndex', rowIndex);

      ingredientsSelect.setAttribute('index', tabIndex + 1);
      ingredientsSelect.setAttribute('tabindex', tabIndex + 4);
      ingredientsSelect.setAttribute('options', JSON.stringify(window.INGREDIENTS));
      unitsSelect.setAttribute('index', tabIndex + 7);
      unitsSelect.setAttribute('tabindex', tabIndex + 7);

      unitsSelect.setAttribute('options', JSON.stringify(window.UNITS));

      window.rowIndex = rowIndex + 1;
    }

    const sortAlphabetically = ({ label: aLabel }, { label: bLabel}) => {
      if (aLabel < bLabel) {
        return -1;
      }
      if (aLabel > bLabel) {
        return 1;
      }
      return 0;
    }

    const updateSelectOptions = (unit, options) => window.table.forEach(select => {
      select[unit].setAttribute('options', JSON.stringify(options));
    });

    const updateIngredients = ingredients => updateSelectOptions('ingredients', ingredients.sort(sortAlphabetically));

    const updateUnits = units => updateSelectOptions('units', units.sort(sortAlphabetically));

    const updateListeners = () => {
      window.table.forEach(({ ingredients: select }) => {
        select.addEventListener('addOption', onAddOption);
      });
    }

    // TODO узнать про res.text, почему он ассинхронный
    const fetchFile = file => fetch(file)
      .then((res) => res.text());

    const init = async () => {
      const ingredients = await fetchFile('./ingredients.js');
      window.INGREDIENTS = JSON.parse(ingredients).map(({ id, name }) => ({ id, label: name }))

      const units = await fetchFile('./units.js');
      window.UNITS = JSON.parse(units).reduce((acc, { id, name }) => ([
          ...acc,
          ...Array.isArray(name)
            ? name.map((word, index ) => ({ id: `${id}_${index}`, label: word }))
            : [{ id, label: name }]
        ]),
      []);

      window.tabIndex = 0;

      addTableRow({
        ingredientSelectId: 's1',
        ingredients: INGREDIENTS,
        unitSelectId: 's2',
        units: UNITS,
        rowIndex: 1,
      });

      window.ingredients = INGREDIENTS;
      window.units = UNITS;
      window.table = [{
        rowIndex: 1,
        ingredients: s1,
        units: s2,
      }];
      window.maxIndex = 3;
      window.rowIndex = 2;

      // updateIngredients(INGREDIENTS);
      // updateUnits(UNITS);
      updateListeners();
    }

    (async () => {
      await init()
    })();
  </script>
</body>

</html>
